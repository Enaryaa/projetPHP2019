format 221
"securite" // application::Test::01Programmation::WIM::WIM2.1::securite
  revision 1
  modified_by 2 "lechartier"
  // class settings
  
  classdiagramsettings member_max_width 0 end
  
  classcompositediagramsettings end
  
  usecasediagramsettings end
  
  sequencediagramsettings end
  
  collaborationdiagramsettings end
  
  objectdiagramsettings end
  
  objectcompositediagramsettings end
  
  componentdiagramsettings
   end
  
  deploymentdiagramsettings
   end
  
  statediagramsettings
   end
  
  activitydiagramsettings
   end
  
  php_dir "01Programmation/WIM/WIM2.1/securite/"
  deploymentview 148738 "securite"
    //deployment diagram settings
    deploymentdiagramsettings
     end
    artifact 221186 "article_list"
      stereotype "source"
      php_src "<?php
require_once 'lib/common.php';
session_start();

$db = initDatabase();
$articles = $db->query(\"SELECT * FROM article\")->fetchAll(PDO::FETCH_OBJ);

?>

<?php
include './templates/header.php';
?>

<body container>

<h1>Liste des articles</h1>

<?php
if (!empty($_SESSION['user'])) {
	echo \"<p>Bonjour, \" . $_SESSION['user']->name . \".</p>\";
}
?>

<ul>
<?php
foreach ($articles as $article) {
	echo '<li><a href=\"article_view.php?id=' . $article->id .'\">'
		. $article->title . \"</a></li>\\n\";
}
?>
</ul>

<?php
include './templates/footer.php';
?>"
      associated_elems
      end
    end

    artifact 221314 "article_view"
      stereotype "source"
      php_src "<?php
require_once 'lib/common.php';
session_start();

if (empty($_GET['id'])) {
	header('Location: article_list.php');
	exit();
}

$db = initDatabase();
$article = $db->query(\"SELECT * FROM article WHERE id=\" . $_GET['id'])
               ->fetch(PDO::FETCH_OBJ);

$article->comments = $db->query(\"SELECT c.*, u.login, u.url \"
								. \"FROM comment c JOIN user u ON c.id_user=u.id\"
								. \" WHERE id_article=\" . $_GET['id'])
                        ->fetchAll(PDO::FETCH_OBJ);

?>
<?php 
include 'templates/header.php';
?>
<body container>

<h1>Article</h1>

<?php

echo '<div  id=\"article\">'
	. '<h3>'. $article->title .'</h3>'
	. '<div id=\"content\">' . $article->content . '</div>';

echo '<h5 class=\"_bb1\">Commentaires</h5>';
if (empty($article->comments)) {
	echo '<p>Aucun</p>';
} else {
	foreach ($article->comments as $comment) {
		echo '<section class=\"alert-box\">';
		echo		 \"<b class='_ts2'>\".$comment->title.\"</b>\"
			. (isset($_SESSION['user']->id) && $comment->id_user == $_SESSION['user']->id ?
			' <a href=\"comment_create.php?id_article=' . $comment->id_article
			. '&amp;id_comment=' . $comment->id . '\" title=\"'. $comment->title
			. '\">Modifier ce commentaire</a>' :
			'')
			. '<p class=\"_ts2\">' . $comment->content .\"</p>\"
			.  \"<p><span class='tag-box -warning'><a href=\\\"$comment->url\\\">$comment->login</a></p>\";
		echo \"</section>\";
	}
}
echo \"</div>\";

if (empty($_SESSION['user'])) {
	echo '<p>Il faut être identifié pour poster un commentaire.</p>';
} else {
	if ($article->closed) {
		echo \"<p>Article fermé, non modifiable.</p>\";
	} else {
		echo '<p> <a href=\"comment_create.php?id_article='. $article->id
			.'\">Ajouter un commentaire</a> avec votre compte : ' . $_SESSION['user']->name
			.' </p>';
	}
}
?>

<p> <a href=\"article_list.php\">Retour à la liste des articles</a> </p>

<?php
include './templates/footer.php';
?>"
      associated_elems
      end
    end

    artifact 221442 "comment_create"
      stereotype "source"
      php_src "<?php
require_once 'lib/common.php';
session_start();

$db = initDatabase();

if (empty($_REQUEST['id_article'])) {
	header('Location: article_list.php');
	exit();
}
if (!empty($_GET['title']) && !empty($_GET['content'])) {
	$title = $_GET['title'];
	$content = $_GET['content'];
	if (empty($_GET['id_comment'])) { // nouveau ou modif ?
		$sql = \"INSERT INTO comment (id_article, title, content, id_user) \"
			.\"VALUES (\".$_GET['id_article'].\", '$title', '$content', \".$_SESSION['user']->id.\")\";
	} else {
		$sql = \"UPDATE comment SET title='$title', content='$content', id_user=\". $_SESSION['user']->id
			.\" WHERE id = \" . $_GET['id_comment'];
	}
	if ($db->query($sql)) {
		header('Location: article_view.php?id=' . $_GET['id_article']);
		exit();
	} else {
		die(\"Erreur  : $sql\");
	}
}
?>
<?php
include './templates/header.php';
?>
<body container>

<h1>Ajouter/modifier un commentaire</h1>
<form action=\"\" method=\"get\">
<fieldset>
<?php if (!empty($_REQUEST['id_comment'])) {
echo '<input name=\"id_comment\" type=\"hidden\" value=\"' . $_REQUEST['id_comment'] .\"\\\" />\\n\";
} ?>
		<input name=\"id_article\" type=\"hidden\" value=\"<?php echo $_REQUEST['id_article']; ?>\" />
<div><label>        Titre  <input name=\"title\" type=\"text\" value=\"\" size=\"60\" /></label></div>
<div> <label>       Texte  <textarea name=\"content\" cols=\"60\" rows=\"6\"></textarea></label></div>
		<button type=\"submit\" name=\"ok\" value=\"1\">Ajouter ce commentaire</button>
</fieldset>
</form>
<?php
	include './templates/footer.php';
?>"
      associated_elems
      end
    end

    artifact 221570 "user_create"
      stereotype "source"
      php_src "<?php
require_once 'lib/common.php';
session_start();

if (!empty($_POST['name']) && !empty($_POST['login']) && !empty($_POST['password'])) {
	$db = initDatabase();
	$sql = \"INSERT INTO user (name, login, password, url) \"
		.\"VALUES ('\".$_POST['name'].\"', '\".$_POST['login'].\"', '\".$_POST['password']
		.\"', '\" . $_POST['url'] . \"')\";
	try{   
		if ($db->query($sql)){
			header('Location: user_login.php');
			exit();
		}else{
			die(\"Erreur !!!!\");
		}
	} catch(PDOException $e) {
		echo \"Erreur: \".$e;
	}
}

?>

<?php
include './templates/header.php';
?>

<body container>

<h1>Création de compte</h1>
<form action=\"\" method=\"POST\">
<fieldset>
<div> 
		<label>Nom  <input name=\"name\" type=\"text\" value=\"\" /> </label>
</div>
	<div><label>	Site perso : <input name=\"url\" type=\"text\" value=\"\" /> </label></div>

<div><label>		Login : <input name=\"login\" type=\"text\" value=\"\" /> </laebl></div>
<div><label>		Mot de passe : <input name=\"password\" type=\"password\" value=\"\" /> </label></div>
		<button type=\"submit\" name=\"ok\" value=\"1\">Créer ce compte</button>
</fieldset>
</form>

<p> <a href=\"article_list.php\">Retour à la liste des articles</a> </p>

<?php
include './templates/footer.php';
?>"
      associated_elems
      end
    end

    artifact 221698 "user_login"
      stereotype "source"
      php_src "<?php
require_once 'lib/common.php';
session_start();

if (!empty($_REQUEST['login']) && !empty($_REQUEST['password'])) {
	$db = initDatabase();
	$sql = \"SELECT * FROM user \"
	.\"WHERE login='\".$_POST['login'].\"' AND password='\".$_POST['password'].\"'\";
	$user = $db->query($sql)->fetch(PDO::FETCH_OBJ);
	if ($user) {
			$_SESSION['user'] = $user;
			header('Location: article_list.php');
			exit();
	}
}

?>
<?php
include 'templates/header.php';
?>"
      associated_elems
      end
    end
  end

  package_ref 151810 // lib
end
